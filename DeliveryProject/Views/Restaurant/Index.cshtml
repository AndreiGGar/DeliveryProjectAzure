@{
    List<CategoryProduct> categoriesByRestaurant = ViewData["CATEGORIES"] as List<CategoryProduct>;
    List<Product> products = ViewData["PRODUCTS"] as List<Product>;
    Restaurant restaurant = ViewData["RESTAURANT"] as Restaurant;
    var cartService = ViewData["SERVICECART"] as ServiceCart;
    string cacheKey = $"cart_{User.Identity.Name}";
    List<int> cart = await cartService.GetCartAsync(cacheKey);
}

<div class="container-fluid">
    <div class="row text-left mb-4">
        <a href="/" style="text-decoration: none; color: black;">
            <i class="fa-solid fa-arrow-left-long"></i> Volver atrás
        </a>
    </div>
    <div class="row">
        <div class="col-md-2 d-none d-md-block">
            <div class="sticky-top">
                <div class="list-group">
                    @foreach (var cat in categoriesByRestaurant)
                    {
                        <a class="list-group-item list-group-item-action" href="#@cat.Name">
                            @cat.Name
                        </a>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-6">
            @if (categoriesByRestaurant == null || !categoriesByRestaurant.Any())
            {
                <div class="alert alert-warning text-center mt-4" role="alert">
                    El restaurante no tiene categorías
                </div>
            }
            else
            {
                @foreach (var cat in categoriesByRestaurant)
                {
                    var productsInCategory = products.Where(p => p.Category == cat.Id && p.IsActive).ToList();
                    <div class="row mb-4" id="@cat.Name">
                        <div class="col-12">
                            <h4>@cat.Name</h4>
                            <hr>
                        </div>
                        @if (productsInCategory.Any())
                        {

                            @foreach (var prod in products.Where(p => p.Category == cat.Id && p.IsActive))
                            {
                                <div class="col-12 mb-4" id="@prod.Id">
                                    <div class="card h-100">
                                        <div class="row g-0">
                                            @if (prod.Image != null)
                                            {
                                                <div class="col-6">
                                                    <img class="card-img-top h-100" src="~/assets/images/products/@prod.Image" alt="@prod.Name">
                                                </div>
                                                <div class="col-6">
                                                    <div class="card-body d-flex flex-column h-100">
                                                        <h5 class="card-title">@prod.Name</h5>
                                                        @if (string.IsNullOrEmpty(prod.Description))
                                                        {
                                                            <p class="card-text"></p>
                                                        }
                                                        else
                                                        {
                                                            <p class="card-text">@prod.Description</p>
                                                        }
                                                        <div class="mt-auto d-flex justify-content-between align-items-center">
                                                            <div class="price">
                                                                @if (prod.IsDiscounted)
                                                                {
                                                                    <h4 class="text-danger"><s>@prod.Price.ToString("C")</s></h4>
                                                                    <h4 class="text-success"> @prod.DiscountPrice?.ToString("C")</h4>
                                                                }
                                                                else
                                                                {
                                                                    <h4 class="text-success">@prod.Price.ToString("C")</h4>
                                                                }
                                                            </div>
                                                            @if (!prod.IsAvailable)
                                                            {
                                                                <div class="availability text-danger"><h6>No disponible</h6></div>
                                                            }
                                                            else
                                                            {
                                                                @*<a href="#" class="btn btn-warning view-product-btn" data-bs-toggle="modal" data-bs-target="#productModal" data-product-id="@prod.Id" data-product-name="@prod.Name" data-product-price="@prod.Price" data-product-discount-price="@prod.DiscountPrice" data-product-description="@prod.Description" data-product-image="@prod.Image">Comprar</a>*@
                                                                @if (cart != null && cart.Contains(prod.Id))
                                                                {
                                                                    <button disabled class="btn btn-danger disabled">En el carrito</button>
                                                                }
                                                                else
                                                                {
                                                                    <a class="btn btn-warning" asp-controller="Restaurant" asp-action="AddCart" asp-route-idproduct="@prod.Id">
                                                                        Comprar
                                                                    </a>
                                                                }
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            } else {
                                                <div class="col-12">
                                                    <div class="card-body d-flex flex-column h-100">
                                                        <h5 class="card-title">@prod.Name</h5>
                                                        @if (string.IsNullOrEmpty(prod.Description))
                                                        {
                                                            <p class="card-text"></p>
                                                        }
                                                        else
                                                        {
                                                            <p class="card-text">@prod.Description</p>
                                                        }
                                                        <div class="mt-auto d-flex justify-content-between align-items-center">
                                                            <div class="price">
                                                                @if (prod.IsDiscounted)
                                                                {
                                                                    <h4 class="text-danger"><s>@prod.Price.ToString("C")</s></h4>
                                                                    <h4 class="text-success"> @prod.DiscountPrice?.ToString("C")</h4>
                                                                }
                                                                else
                                                                {
                                                                    <h4 class="text-success">@prod.Price.ToString("C")</h4>
                                                                }
                                                            </div>
                                                            @if (!prod.IsAvailable)
                                                            {
                                                                <div class="availability text-danger"><h6>No disponible</h6></div>
                                                            }
                                                            else
                                                            {
                                                                @*<a href="#" class="btn btn-warning view-product-btn" data-bs-toggle="modal" data-bs-target="#productModal" data-product-id="@prod.Id" data-product-name="@prod.Name" data-product-price="@prod.Price" data-product-discount-price="@prod.DiscountPrice" data-product-description="@prod.Description" data-product-image="@prod.Image">Comprar</a>*@
                                                                @if (cart != null && cart.Contains(prod.Id))
                                                                {
                                                                    <button disabled class="btn btn-danger disabled">En el carrito</button>
                                                                }
                                                                else
                                                                {
                                                                    <a class="btn btn-warning" asp-controller="Restaurant" asp-action="AddCart" asp-route-idproduct="@prod.Id">
                                                                        Comprar
                                                                    </a>
                                                                }
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>

                            }
                        } else
                        {
                            <div class="alert alert-danger text-dark text-center mt-2" role="alert">
                                <p style="padding:0; margin: 0">La categoría no tiene productos</p>
                            </div>
                        }
                    </div>
                }
            }
        </div>
        <div class="col-md-4 text-center ps-5">
            <div class="w-100 mb-4">
                <img src="~/assets/images/restaurants/@restaurant.Image" class="w-100" style="max-width: auto" />
            </div>
            <h4>@restaurant.Name</h4>
            <h5>Compra mínima: @restaurant.MinimumAmount</h5>
            <h5>Gastos de envío: @restaurant.DeliveryFee</h5>
            <p>@restaurant.Description</p>
            @if (restaurant.Phone != null)
            {
                <p>Telefóno: @restaurant.Phone</p>
            }
            @if (restaurant.ContactEmail != null)
            {
                <p>Email: @restaurant.ContactEmail</p>
            }
            @if (restaurant.Website != null)
            {
                <p>Página web: <a href="@restaurant.Website" target="_blank" style="color: black">@restaurant.Website</a></p>
            }
            <h6 class="mb-4">Dirección: @restaurant.Address, @restaurant.City, @restaurant.ZipCode</h6>
            <div style="width: 100%" class="mt-2"><iframe width="100%" height="500" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="@restaurant.Maps"></iframe></div>
        </div>
    </div>
</div>

@*<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" style="width: 40%">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12 text-center">
                        <img src="" alt="Product Image" class="img-fluid w-100" />
                    </div>
                    <div class="col-12 d-flex flex-column justify-content-between">
                        <div>
                            <h3 class="modal-product-title"></h3>
                            <p class="modal-product-description"></p>
                        </div>
                        <div>
                            <h5 class="modal-product-price"></h5>
                            <h5 class="modal-product-discount-price d-none"></h5>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-secondary quantity-btn quantity-minus-btn">-</button>
                                <div class="mx-3 quantity">1</div>
                                <button class="btn btn-secondary quantity-btn quantity-plus-btn">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary add-to-cart-btn">Add to Cart</button>
            </div>
        </div>
    </div>
</div>

<script>
    function showProductModal(name, description, price, discountedPrice, imageUrl, productId) {
        var modalTitle = document.getElementById("productModalLabel");
        var productName = document.querySelector(".modal-product-title");
        var productDescription = document.querySelector(".modal-product-description");
        var productPrice = document.querySelector(".modal-product-price");
        var productDiscountPrice = document.querySelector(".modal-product-discount-price");
        var productImage = document.querySelector(".modal-body img");
        var quantityButtons = document.querySelectorAll(".quantity-btn");
        var addButton = document.querySelector(".add-to-cart-btn");

        modalTitle.textContent = name;
        productName.textContent = name;
        productDescription.textContent = description || "";
        productImage.setAttribute("src", "/assets/images/products/" + imageUrl);

        // Set the regular price
        productPrice.textContent = price;

        // Check if the product has a discounted price
        if (discountedPrice) {
            productPrice.classList.add("text-danger");
            productPrice.innerHTML = "<s>" + price + "</s>";
            productDiscountPrice.textContent = discountedPrice;
            productDiscountPrice.classList.remove("d-none");
        } else {
            productPrice.classList.remove("text-danger");
            productDiscountPrice.classList.add("d-none");
        }

        // Remove previous event listeners
        quantityButtons.forEach(button => {
            button.removeEventListener("click", handleQuantityButtonClick);
        });

        // Add new event listeners to the quantity buttons
        quantityButtons.forEach(button => {
            button.addEventListener("click", handleQuantityButtonClick);
        });

        var quantityElement = document.querySelector(".quantity");
        quantityElement.textContent = 1; // set initial quantity to 1

        // Add event listener to the add to cart button
        // add event listener to the "Add to Cart" button
        addButton.addEventListener("click", function () {
            fetch(`/Restaurant/AddCart?idproduct=${productId}`, {
                method: 'POST',
            })
                .then(response => {
                    if (response.ok) {
                        return response.text(); // store the response body text in a variable
                    } else {
                        throw new Error('Failed to add product to cart.');
                    }
                })
                .then(text => {
                    var cartCount = document.querySelector("#cartCount");
                    cartCount.textContent = JSON.parse(text).cartCount;
                    var productModal = new bootstrap.Modal(document.getElementById("productModal"));
                    productModal.hide();
                })
                .catch(error => {
                    alert(error.message);
                });
        });
    }

    function handleQuantityButtonClick() {
        var currentQuantity = parseInt(document.querySelector(".quantity").textContent);
        if (this.classList.contains("quantity-minus-btn")) {
            if (currentQuantity > 1) {
                document.querySelector(".quantity").textContent = currentQuantity - 1;
            }
        } else if (this.classList.contains("quantity-plus-btn")) {
            document.querySelector(".quantity").textContent = currentQuantity + 1;
        }
    }

    var viewProductButtons = document.querySelectorAll(".view-product-btn");
    viewProductButtons.forEach(button => {
        button.addEventListener("click", function (event) {
            event.preventDefault();
            var name = this.getAttribute("data-product-name");
            var description = this.getAttribute("data-product-description");
            var price = this.getAttribute("data-product-price");
            var discountedPrice = this.getAttribute("data-product-discount-price");
            var imageUrl = this.getAttribute("data-product-image");
            var productId = this.getAttribute("data-product-id"); // get the product ID attribute value
            showProductModal(name, description, price, discountedPrice, imageUrl, productId);
        });
    });
</script>*@

<style>

    .card-img-top img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .price {
        font-weight: bold;
    }

    .btn-group .form-control {
        width: 50px;
        text-align: center;
    }

    @@media (max-width: 767.98px) {
        .list-group {
            flex-direction: row;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .list-group-item {
            flex-shrink: 0;
            width: 100px;
            max-width: 100px;
            white-space: normal;
            text-overflow: ellipsis;
        }
    }

    @@media (max-width: 575px) {
        .modal-dialog.modal-dialog-centered.modal-lg {
            width: 80% !important;
            margin: 0 auto !important;
        }
    }
</style>